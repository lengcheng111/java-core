server {
    listen 80;
    server_name apiuat.bidvmetlife.com.vn;
    return 301 https://apiuat.bidvmetlife.com.vn$request_uri;
}

server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;
		
	server_name apiuat.bidvmetlife.com.vn;

	#SSL
	#ssl_protocols TLSv1.2;
	ssl_certificate      ssl/apiuat.bidvmetlife.com.vn.cer;
	ssl_certificate_key  ssl/apiuat.bidvmetlife.com.vn.key;
	#ssl_password_file   ssl/ssl_password.txt;
	
	#ssl_trusted_certificate ssl/client_certs.cer;
	
	# This tells Nginx what CA to verify against
	ssl_client_certificate ssl/client_certs.cer;
	# This tells Nginx to verify clients optionally if the client cert is presented in the request
	ssl_verify_client optional;
	
	# security
	include nginxconfig.io/security.conf;

	# logging
	access_log 'logs/apiuat.bidvmetlife.com.vn.access_$logdate.log';
	error_log 'logs/apiuat.bidvmetlife.com.vn.error_$logdate.log' warn;

	# remove sensitive headers
	location / {
		#
		# Wide-open CORS config for nginx
		#
		include global/cors.conf;
		 
		proxy_hide_header X-Powered-By;
		proxy_hide_header Server;
		proxy_hide_header X-Generator;
		proxy_hide_header X-Runtime;
		
		# Block public access due to metlife policy applied from May, 1st 2020
		include nginxconfig.io/blockips.conf;
		
	}
	
	location /publicall {
		allow all;
	}
	
	# reverse proxy
	location /enquiries/ {
		proxy_pass https://server49:8080/enquiries/;
		include nginxconfig.io/proxy.conf;
	}

	location /sso-server/ {
		proxy_pass https://server49:8080/sso-server/;
		#include nginxconfig.io/proxy.conf;
	}

	location /iam/ {
		proxy_pass https://server49:8080/iam/;
		#include nginxconfig.io/proxy.conf;
	}

	location /sales-org/ {

		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;
		
		# allow primeon vpn ip
		allow 10.9.119.252;

		# drop rest of the world
		deny all;

		proxy_pass https://server49:8080/sales-org/;
		include nginxconfig.io/proxy.conf;
	}

	location /dashboard/ {
		proxy_pass https://server49:8080/dashboard/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for FINHAY partner to call insurance api
	location /finhay/ {
		allow all;
		
		# This will return a 403 to all clients without a proper certificate
		#if ($ssl_client_verify != "SUCCESS") { return 403; }
		
		proxy_pass https://server49:8080/finhay/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for BIDV partner to call insurance api
	location /bidv/ {
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;
		# the above firewall rules are applied in UAT only due to MetLife policy.
		# these settings is not applied on PROD.
		
		# This will return a 403 to all clients without a proper certificate
		#if ($ssl_client_verify != "SUCCESS") { return 403; }
		
		proxy_pass https://server49:8080/bidv/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for FINHAY backend tool API
	location /policies/ {
		#allow all;
		
		# This will return a 403 to all clients without a proper certificate
		#if ($ssl_client_verify != "SUCCESS") { return 403; }
		
		proxy_pass https://server49:8080/policies/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for password change supporting ddh+bes
	location /sales/apps/pwd/ {
		proxy_pass https://server49:8080/sales/apps/pwd/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	location /sales/api/v1/pwd/ {
		proxy_pass https://server49:8080/sales/api/v1/pwd/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for password change supporting ddh+bes
	location /sales/apps/adm/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;
		
		proxy_pass https://server49:8080/sales/apps/adm/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	location /sales/api/v1/adm/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;
		
		proxy_pass https://server49:8080/sales/api/v1/adm/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	location /bes/v1 {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;
		
		proxy_pass https://server49:8080/bes/v1/;
		proxy_read_timeout 600s;
		include nginxconfig.io/proxy.conf;
	}
	
	
	# reverse proxy for sending sms, internal use only
	location /sms/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;
		
		proxy_pass http://server46:8243/sms/;
		proxy_read_timeout 60s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo oa webhook from openapi.zalo.me forwarded to http://server46:8243
	location /social/messaging/webhook/zalo/v2/event/ {
		proxy_pass http://server46:8243/zalo-webhook/api/webhook;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo oa webhook from openapi.zalo.me forwarded to http://server46:8243
	location /social/messaging/webhook/zalo-prod/v2/event/ {
		proxy_pass http://server46:8243/zaloiAssistantProd/api/webhook;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo oa api forwarded to http://server46:8243
	location /social/messaging/zalo/v2/message/ {
		proxy_pass http://server46:8243/zaloiAssistant/api/sendMsg;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant white-list api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/white-list/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/white_list/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant black-list api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/black-list/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/black_list/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant official-account api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/oa/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/official_account/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant report message logs api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/report/messages/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/report/message/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant report transaction logs api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/report/transactions/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/report/transactions/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant report webhook logs api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/report/webhook/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/report/webhook/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant report agents api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/report/agents/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/report/agents/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for zalo iAssistant agents api forwarded to API Gateway http://server46:8243
	location /social/messaging/zalo/v2/agents/ {
		
		# allow anyone in 10.199.146.0/24, office vlan
		allow 10.199.146.0/24;

		# allow anyone in 10.199.164.0/24, vpn vlan
		allow 10.199.164.0/24;

		# allow anyone from internet (through F5 load balancer)
		#allow 10.199.165.162;

		# drop rest of the world
		deny all;

		proxy_pass http://server46:8243/zaloiAssistant/api/agents/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	
	# reverse proxy for IWS-API GoGreen Project forwarded to http://server46:8243
	location /v1/iws-api/ {
		proxy_pass http://server46:8243/v1/iws-api/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for go-green portal api forwarded to http://server46:8243
	location /v1/customers/policies/ {
		
		if ($request_method = OPTIONS) {			  
		  add_header 'Access-Control-Allow-Origin'  'https://servicesuat.bidvmetlife.com.vn';			  
		  add_header 'Access-Control-Allow-Headers' 'Access-Control-Allow-Headers, Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers, Authorization, Pragma, X-Frame-Options, x-frontend-json, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Cache-Control';			  			  
		  return 200;
		}
			
		proxy_pass http://server46:8243/portal-service/portal/customer/policies/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	# reverse proxy for go-green portal admin api forwarded to http://server46:8243
	location /v1/portal/admin/ {
		
		if ($request_method = OPTIONS) {			  
		  add_header 'Access-Control-Allow-Origin'  'https://servicesuat.bidvmetlife.com.vn';			  
		  add_header 'Access-Control-Allow-Headers' 'Access-Control-Allow-Headers, Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers, Authorization, Pragma, X-Frame-Options, x-frontend-json, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Cache-Control';			  			  
		  return 200;
		}
		
		proxy_pass http://server46:8243/portal-service/portal/admin/;
		proxy_read_timeout 120s;
		include nginxconfig.io/proxy.conf;
	}
	
	
	error_page		500 502 503 504  /50x.html;
	error_page 		403 /publicall/403_6.html;

	location = /50x.html {
		root   html;
	}
	
	location = /publicall/403.html {
		root html;
	}
}